<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Veilrot Rules</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="veilrot_rules.css">
  <script src="/js/abilities.js"></script>
  <style>
    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
      margin: 0;
      padding: 0;
    }

    .collapsible-content.expanded {
      max-height: none;
      transition: max-height 0.5s ease-in;
    }

    /* Base button styling */
    .section-button {
      display: block;
      width: 100%;
      text-align: left;
      padding: 0.5rem 0.75rem;
      margin: 0;
      border: none;
      border-radius: 0.5rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      background-color: #e2e8f0;
      color: #1e293b;
    }

    .section-button:hover {
      background-color: #cbd5e1;
    }

    .section-button.expanded {
      background-color: #94a3b8;
      color: white;
    }

    /* Top level sections (Introduction, Core Rules, etc.) */
    .top-level-button {
      background-color: #1e293b !important;
      color: white !important;
      font-size: 1.25rem !important;
      font-weight: bold !important;
      padding: 0.75rem !important;
      width: 100% !important;
      text-align: left !important;
      border-radius: 0.75rem !important;
      margin-bottom: 0 !important;
    }

    .top-level-button:hover {
      background-color: #334155 !important;
    }

    .top-level-button.expanded {
      background-color: #475569 !important;
    }

    /* Main section buttons (under top level) */
    .main-section-button {
      background-color: #334155 !important;
      color: white !important;
      font-size: 1.1rem !important;
      font-weight: 600 !important;
      padding: 0.625rem 0.75rem !important;
      margin: 0 !important;
      border-radius: 0.625rem !important;
      width: 100% !important;
    }

    .main-section-button:hover {
      background-color: #475569 !important;
    }

    .main-section-button.expanded {
      background-color: #64748b !important;
    }

    /* Subsection buttons */
    .subsection-button {
      background-color: #e2e8f0 !important;
      color: #1e293b !important;
      font-size: 1rem !important;
      font-weight: 500 !important;
      padding: 0.5rem 0.75rem !important;
      margin: 0 !important;
      border-radius: 0.5rem !important;
      width: 100% !important;
    }

    .subsection-button:hover {
      background-color: #cbd5e1 !important;
    }

    .subsection-button.expanded {
      background-color: #94a3b8 !important;
      color: white !important;
    }

    /* Detail buttons */
    .detail-button {
      background-color: #f8fafc !important;
      color: #1e293b !important;
      font-size: 0.9rem !important;
      font-weight: 400 !important;
      padding: 0.375rem 0.75rem !important;
      margin: 0 !important;
      border-radius: 0.375rem !important;
      width: 100% !important;
    }

    .detail-button:hover {
      background-color: #f1f5f9 !important;
    }

    .detail-button.expanded {
      background-color: #e2e8f0 !important;
      color: #1e293b !important;
    }

    /* Content boxes */
    .content-box {
      padding: 0.75rem;
      background-color: white;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      margin: 0;
      width: 100%;
    }

    .section-content {
      margin: 0;
      padding: 0;
    }

    .section-content > * {
      margin: 0;
      padding: 0;
    }

    .section-content > * + * {
      margin-top: 1rem;
    }

    .section-buttons {
      margin: 0;
      padding: 0;
      margin-top: 0.5rem;
      width: 100%;
    }

    .section-buttons > * {
      margin: 0;
      padding: 0;
      width: 100%;
    }

    .section-buttons > * + * {
      margin-top: 0.25rem;
    }

    button {
      transition: background-color 0.2s ease, color 0.2s ease;
    }

    button + .collapsible-content {
      margin-top: 0;
    }

    /* Ensure content wrapper always has a white background when expanded */
    .collapsible-content.expanded {
      background-color: white;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      margin: 0;
      padding: 0.75rem;
      width: 100%;
    }

    /* Adjust nested button margins when inside expanded content */
    .collapsible-content.expanded .section-button {
      margin: 0;
      width: 100%;
    }

    .collapsible-content.expanded .section-button:first-child {
      margin-top: 0;
    }

    .collapsible-content.expanded .section-button:last-child {
      margin-bottom: 0;
    }

    /* Remove content box when parent is expanded */
    .collapsible-content.expanded > .content-box {
      margin: 0;
      padding: 0;
      border: none;
      background: none;
      width: 100%;
    }

    /* Bullet point styling */
    ul, ol {
      list-style-type: disc !important;
      margin-left: 3.5rem !important;
      padding-left: 0 !important;
      list-style-position: outside !important;
      margin-top: 1rem !important;
      margin-bottom: 1rem !important;
    }

    ul li, ol li {
      margin-bottom: 0.75rem !important;
      text-align: left !important;
      line-height: 1.5 !important;
      position: relative !important;
      display: list-item !important;
    }

    /* Style for inline lists */
    ul[style*="display:inline-block"] {
      display: inline-block !important;
      margin-left: 3.5rem !important;
      padding-left: 0 !important;
      list-style-type: disc !important;
      margin-top: 1rem !important;
      margin-bottom: 1rem !important;
    }

    ul[style*="display:inline-block"] li {
      display: list-item !important;
      list-style-type: disc !important;
      margin-bottom: 0.75rem !important;
    }

    /* Top level section styling */
    .top-level-section {
      margin-bottom: 1rem;
    }

    /* Mission Rules specific styling */
    .mission-rules-content {
      margin-left: 0 !important;
    }

    .mission-rules-content .section-buttons {
      margin-left: 0 !important;
    }

    .mission-rules-content .section-button {
      font-size: 1rem !important;
      padding: 0.5rem 1rem !important;
    }

    .mission-rules-content .top-level-button {
      font-size: 1.2rem !important;
      padding: 0.75rem 1rem !important;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900 py-8">
  <div class="mx-auto w-full max-w-[800px] px-4">
    <h1 class="text-3xl font-bold mb-8 text-center">Veilrot Rules</h1>
    <div id="rules-container" class="space-y-4">
      <div class="flex flex-col gap-4">
        <div class="flex flex-col gap-4">
          <div>
            <select id="narrativeLayer" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
              <option value="">Select Narrative Layer</option>
            </select>
          </div>
          <div>
            <select id="objectiveSetup" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
              <option value="">Select Objective Setup</option>
            </select>
          </div>
          <div>
            <select id="missionRule" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
              <option value="">Select Mission Rule</option>
            </select>
          </div>
          <div>
            <select id="deploymentType" class="w-[400px] px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
              <option value="">Select Deployment Type</option>
            </select>
          </div>
          <div>
            <select id="player1Zone" class="w-[400px] px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
              <option value="">Select Player 1 Zone</option>
            </select>
          </div>
          <div>
            <select id="player2Zone" class="w-[400px] px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
              <option value="">Select Player 2 Zone</option>
            </select>
          </div>
        </div>
        <div class="mt-4">
          <div id="missionContent" class="p-4 bg-white rounded-lg shadow">
            <!-- Content will be loaded here without title -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // List of JSON files to load with their hierarchy
    const jsonFiles = [
      { file: 'introduction.json', parent: null },
      { file: 'core_rules.json', parent: null },
      { file: 'the_warband.json', parent: null },
      { file: 'equipment.json', parent: null },
      { file: 'battles.json', parent: null },
      { file: 'generate_mission.json', parent: null }
    ];

    // Function to load a single JSON file
    async function loadJsonFile(filename) {
      try {
        console.log(`Attempting to load ${filename}...`);
        const response = await fetch(`data/${filename}`);
        if (!response.ok) {
          console.error(`Failed to load ${filename}: ${response.status} ${response.statusText}`);
          return null;
        }
        const data = await response.json();
        console.log(`Successfully loaded ${filename}`);
        return data;
      } catch (error) {
        console.error(`Error loading ${filename}:`, error);
        return null;
      }
    }

    // Function to load all JSON files
    async function loadAllJsonFiles() {
      const container = document.getElementById('rules-container');
      const loadingDiv = document.createElement('div');
      loadingDiv.textContent = 'Loading rules...';
      container.appendChild(loadingDiv);

      try {
        console.log('Starting to load all JSON files...');
        const results = await Promise.all(jsonFiles.map(file => loadJsonFile(file.file)));
        const validResults = results.filter(result => result !== null);
        
        console.log(`Loaded ${validResults.length} out of ${jsonFiles.length} files`);
        
        // Clear loading message
        container.innerHTML = '';

        if (validResults.length === 0) {
          container.innerHTML = '<div class="text-red-500">Failed to load any rules files. Please check the console for errors.</div>';
          return;
        }

        // Create a map of loaded files
        const fileMap = new Map();
        jsonFiles.forEach((file, index) => {
          if (results[index]) {
            fileMap.set(file.file, {
              data: results[index],
              parent: file.parent
            });
          }
        });

        // Process top-level sections
        for (const file of jsonFiles) {
          if (!file.parent && fileMap.has(file.file)) {
            const data = fileMap.get(file.file).data;
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'top-level-section';

            // Create the section title button
            const button = document.createElement('button');
            button.textContent = data.title;
            button.className = 'top-level-button';
            button.setAttribute('data-section', file.file.replace('.json', ''));
            sectionDiv.appendChild(button);

            // Create content wrapper
            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'collapsible-content';
            contentWrapper.setAttribute('data-content', file.file.replace('.json', ''));
            sectionDiv.appendChild(contentWrapper);

            // Add the section's content if it exists
            if (data.content) {
              const contentDiv = document.createElement('div');
              contentDiv.className = 'px-6 py-4 bg-white border border-gray-300 rounded mb-4';
              contentDiv.innerHTML = data.content;
              contentWrapper.appendChild(contentDiv);
            }

            // Add subsections
            if (Array.isArray(data.sections)) {
              const subsectionsDiv = document.createElement('div');
              subsectionsDiv.className = 'space-y-4';
              for (const section of data.sections) {
                renderSection(section, subsectionsDiv, 1);
              }
              contentWrapper.appendChild(subsectionsDiv);
            }

            // Add child sections
            for (const childFile of jsonFiles) {
              if (childFile.parent === file.file && fileMap.has(childFile.file)) {
                const childData = fileMap.get(childFile.file).data;
                // Create a section object that matches the structure expected by renderSection
                const childSection = {
                  title: childData.title,
                  content: childData.content,
                  sections: childData.sections || [],
                  file: childData.file
                };
                // Use renderSection with level 1 to match Mission List styling
                renderSection(childSection, contentWrapper, 1);
              }
            }

            // Toggle visibility when clicking the button
            button.addEventListener('click', () => {
              const willShow = !contentWrapper.classList.contains('expanded');
              contentWrapper.classList.toggle('expanded');
              button.classList.toggle('expanded');
            });

            container.appendChild(sectionDiv);
          }
        }

        // Add button handlers after all content is loaded
        addButtonHandlers();
      } catch (error) {
        console.error('Error in loadAllJsonFiles:', error);
        container.innerHTML = `<div class="text-red-500">Failed to load rules: ${error.message}</div>`;
      }
    }

    function renderSection(section, container, level = 0) {
      const sectionDiv = document.createElement('div');
      sectionDiv.className = '';

      // Create the section button
      const button = document.createElement('button');
      button.textContent = section.title;
      
      // Determine button class based on section type and level
      if (level === 0) {
        button.className = 'top-level-button';
      } else if (level === 1) {
        button.className = 'main-section-button';
      } else if (level === 2) {
        button.className = 'subsection-button';
      } else {
        button.className = 'detail-button';
      }

      // Set data-section without .json extension
      const sectionFile = section.file ? section.file.replace('.json', '') : '';
      button.setAttribute('data-section', sectionFile);
      sectionDiv.appendChild(button);

      // Create content wrapper
      const contentWrapper = document.createElement('div');
      contentWrapper.className = 'collapsible-content';
      contentWrapper.setAttribute('data-content', sectionFile);
      sectionDiv.appendChild(contentWrapper);

      // Create content box if there's content or subsections
      if (section.content || (section.sections && section.sections.length > 0)) {
        const contentBox = document.createElement('div');
        contentBox.className = 'content-box';

        // Add content if it exists
        if (section.content) {
          const contentDiv = document.createElement('div');
          contentDiv.className = 'section-content';
          contentDiv.innerHTML = section.content;
          contentBox.appendChild(contentDiv);
        }

        // Add subsections if they exist
        if (section.sections && section.sections.length > 0) {
          const subsectionsDiv = document.createElement('div');
          subsectionsDiv.className = 'section-buttons';
          for (const subsection of section.sections) {
            // Create a content div for each subsection
            const subsectionContent = document.createElement('div');
            subsectionContent.className = 'section-content';
            if (subsection.file) {
              subsectionContent.setAttribute('data-content', subsection.file.replace('.json', ''));
            }
            contentBox.appendChild(subsectionContent);
            
            // Render the subsection button
            renderSection(subsection, subsectionsDiv, level + 1);
          }
          contentBox.appendChild(subsectionsDiv);
        }

        contentWrapper.appendChild(contentBox);
      }

      // Toggle visibility when clicking the button
      button.addEventListener('click', () => {
        const willShow = !contentWrapper.classList.contains('expanded');
        contentWrapper.classList.toggle('expanded');
        button.classList.toggle('expanded');
        
        // If this is a subsection with a file, load its content when expanded
        if (willShow && section.file) {
          loadJsonFile(section.file).then(data => {
            if (data && data.content) {
              const contentDiv = contentWrapper.querySelector('.section-content');
              if (contentDiv) {
                contentDiv.innerHTML = data.content;
                // After loading content, set up tooltips
                setupAbilities();
                createTraitTooltips();
              }
            }
          }).catch(error => {
            console.error(`Error loading content for ${section.file}:`, error);
          });
        }
      });

      container.appendChild(sectionDiv);
    }

    // Function to handle button clicks
    function handleButtonClick(button) {
      const content = button.nextElementSibling;
      if (content && content.classList.contains('collapsible-content')) {
        content.classList.toggle('expanded');
        button.classList.toggle('expanded');
      }
    }

    // Add click handlers to all buttons
    function addButtonHandlers() {
      const buttons = document.querySelectorAll('.section-button, .top-level-button, .main-section-button, .subsection-button, .detail-button');
      buttons.forEach(button => {
        // Remove any existing click handlers
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
        // Add new click handler
        newButton.addEventListener('click', () => handleButtonClick(newButton));
      });
    }

    // Load all JSON files when the page loads
    document.addEventListener('DOMContentLoaded', loadAllJsonFiles);
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="/js/mission_name_generator.js"></script>
  <script src="/js/mission.js"></script>
  <script src="js/abilities.js"></script>
  <script src="js/content.js"></script>
  <script src="js/narrative.js"></script>
  <script src="js/images.js"></script>
</body>
</html>
