<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Veilrot Rules (Centered + Nested)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="veilrot_rules.css">
  <script src="/js/abilities.js"></script>
    <style>
    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
      margin: 0;
      padding: 0;
    }

    .collapsible-content.expanded {
      max-height: none;
      transition: max-height 0.5s ease-in;
    }

    .section-button {
      display: block;
      width: 100%;
      text-align: left;
      padding: 0.75rem 1rem;
      margin: 0;
      border: none;
      border-radius: 0.375rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .content-box {
      padding: 1rem;
      background-color: white;
      border: 1px solid #e5e7eb;
      border-radius: 0.375rem;
      margin: 0;
    }

    .section-content {
      margin: 0;
      padding: 0;
    }

    .section-content > * {
      margin: 0;
      padding: 0;
    }

    .section-content > * + * {
      margin-top: 1rem;
    }

    .section-buttons {
      margin: 0;
      padding: 0;
      margin-top: 1.5rem;
    }

    .section-buttons > * {
      margin: 0;
      padding: 0;
    }

    .section-buttons > * + * {
      margin-top: 0.5rem;
    }

    button {
      transition: background-color 0.2s ease, color 0.2s ease;
    }
    .level-1 { margin-left: 0rem; }
    .level-2 { margin-left: 1rem; }
    .level-3 { margin-left: 2rem; }
    .level-4 { margin-left: 3rem; }
    button + .collapsible-content { margin-top: 0; }

    /* Bullet point styling */
    ul, ol {
      list-style-type: disc !important;
      margin-left: 3.5rem !important;
      padding-left: 0 !important;
      list-style-position: outside !important;
      margin-top: 1rem !important;
      margin-bottom: 1rem !important;
    }

    ul li, ol li {
      margin-bottom: 0.75rem !important;
      text-align: left !important;
      line-height: 1.5 !important;
      position: relative !important;
      display: list-item !important;
    }

    /* Style for inline lists */
    ul[style*="display:inline-block"] {
      display: inline-block !important;
      margin-left: 3.5rem !important;
      padding-left: 0 !important;
      list-style-type: disc !important;
      margin-top: 1rem !important;
      margin-bottom: 1rem !important;
    }

    ul[style*="display:inline-block"] li {
      display: list-item !important;
      list-style-type: disc !important;
      margin-bottom: 0.75rem !important;
    }

    /* Top level section styling */
    .top-level-section {
      margin-bottom: 1rem;
    }

    .top-level-button {
      background-color: #1e293b !important;
      color: white !important;
      font-size: 1.5rem !important;
      font-weight: bold !important;
      padding: 1rem !important;
      width: 100% !important;
      text-align: left !important;
      border-radius: 0.5rem !important;
      margin-bottom: 0.5rem !important;
    }

    .top-level-button:hover {
      background-color: #334155 !important;
    }

    .top-level-button.expanded {
      background-color: #475569 !important;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900 py-8">
  <div class="mx-auto w-full max-w-[800px] px-4">
    <h1 class="text-3xl font-bold mb-8 text-center">Veilrot Rules</h1>
    <div id="rules-container" class="space-y-4"></div>
  </div>

  <script>
    // List of JSON files to load with their hierarchy
    const jsonFiles = [
      { file: 'introduction.json', parent: null },
      { file: 'core_rules.json', parent: null },
      { file: 'the_warband.json', parent: null },
      { file: 'equipment.json', parent: null },
      { file: 'battles.json', parent: null },
      { file: 'player_objectives.json', parent: 'battles.json' },
      { file: 'narrative_layers.json', parent: 'battles.json' }
    ];

    // Function to load a single JSON file
    async function loadJsonFile(filename) {
      try {
        console.log(`Attempting to load ${filename}...`);
        const response = await fetch(`data/${filename}`);
        if (!response.ok) {
          console.error(`Failed to load ${filename}: ${response.status} ${response.statusText}`);
          throw new Error(`Failed to load ${filename}: ${response.status} ${response.statusText}`);
        }
        const data = await response.json();
        console.log(`Successfully loaded ${filename}`);
        return data;
      } catch (error) {
        console.error(`Error loading ${filename}:`, error);
        return null;
      }
    }

    // Function to load all JSON files
    async function loadAllJsonFiles() {
      const container = document.getElementById('rules-container');
      const loadingDiv = document.createElement('div');
      loadingDiv.textContent = 'Loading rules...';
      container.appendChild(loadingDiv);

      try {
        console.log('Starting to load all JSON files...');
        const results = await Promise.all(jsonFiles.map(file => loadJsonFile(file.file)));
        const validResults = results.filter(result => result !== null);
        
        console.log(`Loaded ${validResults.length} out of ${jsonFiles.length} files`);
        
        // Clear loading message
        container.innerHTML = '';

        if (validResults.length === 0) {
          container.innerHTML = '<div class="text-red-500">Failed to load any rules files. Please check the console for errors.</div>';
          return;
        }

        // Create a map of loaded files
        const fileMap = new Map();
        jsonFiles.forEach((file, index) => {
          if (results[index]) {
            fileMap.set(file.file, {
              data: results[index],
              parent: file.parent
            });
          }
        });

        // Process top-level sections
        jsonFiles.forEach(file => {
          if (!file.parent && fileMap.has(file.file)) {
            const data = fileMap.get(file.file).data;
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'top-level-section';

            // Create the section title button
            const button = document.createElement('button');
            button.textContent = data.title;
            button.className = 'top-level-button';
            sectionDiv.appendChild(button);

            // Create content wrapper
            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'collapsible-content';
            sectionDiv.appendChild(contentWrapper);

            // Add the section's content if it exists
            if (data.content) {
              const contentDiv = document.createElement('div');
              contentDiv.className = 'px-6 py-4 bg-white border border-gray-300 rounded mb-4';
              contentDiv.innerHTML = data.content;
              contentWrapper.appendChild(contentDiv);
            }

            // Add subsections
            if (Array.isArray(data.sections)) {
              const subsectionsDiv = document.createElement('div');
              subsectionsDiv.className = 'space-y-4';
              data.sections.forEach(section => renderSection(section, subsectionsDiv, 1));
              contentWrapper.appendChild(subsectionsDiv);
            }

            // Add child sections
            jsonFiles.forEach(childFile => {
              if (childFile.parent === file.file && fileMap.has(childFile.file)) {
                const childData = fileMap.get(childFile.file).data;
                // Create a section object that matches the structure expected by renderSection
                const childSection = {
                  title: childData.title,
                  content: childData.content,
                  sections: childData.sections || [],
                  file: childData.file
                };
                // Use renderSection with level 1 to match Mission List styling
                renderSection(childSection, contentWrapper, 1);
              }
            });

            // Toggle visibility when clicking the button
            button.addEventListener('click', () => {
              const willShow = !contentWrapper.classList.contains('expanded');
              contentWrapper.classList.toggle('expanded');
              button.classList.toggle('expanded');
            });

            container.appendChild(sectionDiv);
          }
        });
      } catch (error) {
        console.error('Error in loadAllJsonFiles:', error);
        container.innerHTML = `<div class="text-red-500">Failed to load rules: ${error.message}</div>`;
      }
    }

    function renderSection(section, container, level = 0) {
      const sectionDiv = document.createElement('div');
      sectionDiv.className = '';

      // Create the section button
      const button = document.createElement('button');
      button.textContent = section.title;
      button.className = `section-button bg-slate-${300 + level * 100} hover:bg-slate-${400 + level * 100} text-${level === 0 ? 'white' : 'black'}`;
      sectionDiv.appendChild(button);

      // Create content wrapper
      const contentWrapper = document.createElement('div');
      contentWrapper.className = 'collapsible-content';
      sectionDiv.appendChild(contentWrapper);

      // Create content box if there's content or subsections
      if (section.content || (section.sections && section.sections.length > 0) || section.file) {
        const contentBox = document.createElement('div');
        contentBox.className = 'content-box';

        // Add content if it exists
        if (section.content) {
          const contentDiv = document.createElement('div');
          contentDiv.className = 'section-content';
          contentDiv.innerHTML = section.content;
          contentBox.appendChild(contentDiv);
        }

        // Load file content if specified
        if (section.file) {
          const contentDiv = document.createElement('div');
          contentDiv.className = 'section-content';
          loadJsonFile(section.file).then(data => {
            if (data && data.content) {
              contentDiv.innerHTML = data.content;
            }
          });
          contentBox.appendChild(contentDiv);
        }

        // Add subsections if they exist
        if (section.sections && section.sections.length > 0) {
          const subsectionsDiv = document.createElement('div');
          subsectionsDiv.className = 'section-buttons';
          section.sections.forEach(subsection => renderSection(subsection, subsectionsDiv, level + 1));
          contentBox.appendChild(subsectionsDiv);
        }

        contentWrapper.appendChild(contentBox);
      }

      // Toggle visibility when clicking the button
      button.addEventListener('click', () => {
        const willShow = !contentWrapper.classList.contains('expanded');
        contentWrapper.classList.toggle('expanded');
        button.className = `section-button ${willShow ? `bg-slate-${600 + level * 100} hover:bg-slate-${700 + level * 100} text-white` : `bg-slate-${300 + level * 100} hover:bg-slate-${400 + level * 100} text-${level === 0 ? 'white' : 'black'}`}`;
      });

      container.appendChild(sectionDiv);
    }

    // Load all JSON files when the page loads
    loadAllJsonFiles();
  </script>
</body>
</html>
